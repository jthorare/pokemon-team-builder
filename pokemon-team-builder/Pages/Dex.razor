@page "/pokedex"
@using pokemon_team_builder.Components
@using pokemon_team_builder.PokemonCommon
@using pokemon_team_builder.Services
@inject PokeApiService pokeService

<h3>Pokedex</h3>

<Div>
    <Blazorise.Components.Autocomplete TItem="PokemonEntry" TValue="PokemonEntry" Data="@PokemonInDex"
                                       TextField="@((item) => item.PokemonSpecies.Name)" ValueField="@((item) => item)" Placeholder="Search ..."
                                       Filter="Blazorise.Components.AutocompleteFilter.StartsWith">
        <NotFoundContent> Sorry ... @context was not found.</NotFoundContent>
    </Blazorise.Components.Autocomplete>

    <Div>
        <Button Color="Color.Primary" Clicked="@ClearFilters">Clear Filters</Button>

        <Div>
            <Label>Type 1: </Label>
            <RadzenDropDown TValue="string" Data=@Types1 Placeholder="Choose a type" AllowClear="true" AllowFiltering="true" SelectedItemsText=@Type2 Change=@(async (args) => await TypeFilterChanged(args, false)) />
            <Label>Type 2: </Label>
            <RadzenDropDown TValue="string" Data=@Types2 Placeholder="Choose a type" AllowClear="true" AllowFiltering="true" SelectedItemsText=@Type2 Change=@(async (args) => await TypeFilterChanged(args, true)) />
        </Div>
    </Div>
</Div>

<Div>
    @foreach (PokemonEntry pokemon in PokemonInDex)
    {
        <PokemonComponent PokedexId=@PokemonUtilities.GetNatDexId(pokemon.PokemonSpecies.Url) />
    }
</Div>

@code {
    // TODO rewrite the image drawing using a Datagrid
    private string Type1 { get; set; } = "";
    private string Type2 { get; set; } = "";
    private IEnumerable<string> Types { get; set; } = PokeApiConstants.TypeMappings.Keys.ToList();
    private IEnumerable<string> Types1 { get; set; } = PokeApiConstants.TypeMappings.Keys.ToList();
    private IEnumerable<string> Types2 { get; set; } = PokeApiConstants.TypeMappings.Keys.ToList();

    List<PokemonEntry> PokemonInDex { get; set; } = new();
    List<PokemonEntry> NationalDex { get; set; } = new();

    /// <summary>
    /// Populates the displayed dex and the cached NationalDex.
    /// </summary>
    /// <returns>A Task for async purposes.</returns>
    protected override async Task OnInitializedAsync()
    {
        Pokedex pokedex = await pokeService.GetPokedex("national");
        PokemonInDex.AddRange(pokedex.PokemonEntries);
        NationalDex = pokedex.PokemonEntries;
    }

    /// <summary>
    /// Removes the filters from the displayed dex.
    /// </summary>
    private void ClearFilters()
    {
        Type1 = "";
        Type2 = "";
        PokemonInDex.Clear();
        PokemonInDex.AddRange(NationalDex);
        Console.WriteLine($"PokemonInDex count {PokemonInDex.Count}");
        Console.WriteLine($"NationalDex count {NationalDex.Count}");
        StateHasChanged();
    }

    private void ChangeType(string type, bool two)
    {
        if (!two)
        {
            Type1 = type;
        }
        if (two)
        {
            Type2 = type;
        }
    }

    /// <summary>
    /// Event handler for the Type Filters.
    /// </summary>
    /// <param name="args">The type (string) as an object.</param>
    /// <param name="two">Is this firing because it is for Type2?</param>
    /// <returns>Task for async purposes.</returns>
    private async Task TypeFilterChanged(object args, bool two)
    {
        if (args is not null)
        {
            string type = (string)args;
            ChangeType(type, two);
        }
        if (args is null) // this event gets fired by clearing the dropdowns
        {
            ChangeType("", two);
        }

        //  get the Type that isn't null, refilter
        PokemonInDex = await FilterDex();
        Types1 = Types.Where(type => type != Type2);
        Types2 = Types.Where(type => type != Type1);

        StateHasChanged();
    }

    private async Task<List<PokemonEntry>> FilterDex()
    {
        HashSet<string> pokemonOfType1;
        HashSet<string> pokemonOfType2;
        if (String.IsNullOrEmpty(Type1)) // if there is no filter, default to all pokemon
        {
            pokemonOfType1 = NationalDex.Select(x => x.PokemonSpecies.Name).ToHashSet();
        }
        else
        {
            pokemonOfType1 = await pokeService.GetPokemonOfType(Type1); // get the pokemon of that type
        }
        if (String.IsNullOrEmpty(Type2)) // if there is no filter, default to all pokemon

        {
            pokemonOfType2 = NationalDex.Select(x => x.PokemonSpecies.Name).ToHashSet();
        }
        else
        {
            pokemonOfType2 = await pokeService.GetPokemonOfType(Type2); // get the pokemon of that type
        }
        HashSet<string> pokemonOfBothTypes = pokemonOfType1.Where(pokemon => pokemonOfType2.Contains(pokemon)).ToHashSet();
        return NationalDex.Where(pokemon => pokemonOfBothTypes.Contains(pokemon.PokemonSpecies.Name)).ToList();
    }
}